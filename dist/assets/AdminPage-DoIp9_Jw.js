import{r as c,d as p,j as e,s as N}from"./index-CLjvfxVe.js";import{a as ee,b as Ie,g as ke}from"./trips-BOHQsqPE.js";const u="travel_db",R="68a1ce77001ee1b076d4",w="trip-media",k="68a1d1ee00065f1b5f0d",H="bookings",te="68a1e4dd000b208d3eea";function Se(){const[x,D]=c.useState("trips"),[se,ae]=c.useState([]),[ie,G]=c.useState(!1),[le,oe]=c.useState([]),[ne,z]=c.useState(!1),[de,re]=c.useState([]),[ce,J]=c.useState(!1),T={id:null,title:"",price:"",date:"",imageIds:[],priority:!1},[n,v]=c.useState(T),[C,O]=c.useState(null),[I,P]=c.useState(null),[_,h]=c.useState([]),[U,F]=c.useState([]),[L,B]=c.useState({}),[Q,E]=c.useState([]),[W,X]=c.useState(!1),[me,d]=c.useState("");c.useEffect(()=>{x==="trips"&&$(),x==="bookings"&&A(),x==="payments"&&V()},[x]);async function $(){G(!0),d("");try{const t=await p.listDocuments(u,R);ae(t.documents||[])}catch(t){console.error(t),d(t.message||"Failed to load trips")}finally{G(!1)}}async function A(){z(!0),d("");try{const t=await p.listDocuments(u,H);oe(t.documents||[])}catch(t){console.error(t),d(t.message||"Failed to load bookings")}finally{z(!1)}}async function V(){J(!0),d("");try{const t=await p.listDocuments(u,te);re(t.documents||[])}catch(t){console.error(t),d(t.message||"Failed to load payments")}finally{J(!1)}}const pe=()=>h(t=>[...t,{name:"",description:"",images:[],video:null,videoId:null,extraDetails:""}]),q=(t,s)=>h(i=>i.map((a,m)=>m===t?{...a,...s}:a)),ue=t=>h(s=>s.filter((i,a)=>a!==t)),ge=(t,s)=>{if(!s||s.length===0)return;const i=Array.from(s);h(a=>a.map((m,y)=>y===t?{...m,images:[...m.images||[],...i]}:m))},xe=(t,s)=>{h(i=>i.map((a,m)=>{if(m!==t)return a;const y=Array.isArray(a.images)?[...a.images]:[];return y.splice(s,1),{...a,images:y}}))},he=(t,s)=>{h(i=>i.map((a,m)=>m===t?{...a,video:s,videoId:null}:a))},ye=t=>{h(s=>s.map((i,a)=>a===t?{...i,video:null,videoId:null}:i))};async function fe(t){t&&t.preventDefault&&t.preventDefault(),X(!0),d("");try{const s=Array.isArray(n.imageIds)?[...n.imageIds]:[],i=[];for(let o=0;o<s.length;o++)if(!Q.includes(o))if(L[o]){const j=await N.createFile(w,"unique()",L[o]);i.push(j.$id)}else i.push(s[o]);if(U&&U.length>0){const o=U.map(l=>N.createFile(w,"unique()",l)),j=await Promise.all(o);i.push(...j.map(l=>l.$id))}const a={title:n.title,price:Number(n.price||0),date:n.date||null,imageIds:i,priority:!!n.priority};let m=null;if(C instanceof File)try{const o=await N.createFile(w,"unique()",C);m=o.$id,a.videoId=o.$id}catch(o){console.warn("Failed to upload trip-level video:",(o==null?void 0:o.message)||o)}else typeof I=="string"&&I&&(a.videoId=I);let y;if(n.id?y=await p.updateDocument(u,R,n.id,a):y=await p.createDocument(u,R,"unique()",a),k&&_.length>0){let o=!1,j=!1;for(const l of _){const f=[];if(Array.isArray(l.images))for(const r of l.images)if(r instanceof File){const g=await N.createFile(w,"unique()",r);f.push(g.$id)}else typeof r=="string"&&r&&f.push(r);let Y=l.videoId||null,S=null;if(l.video instanceof File)try{const r=await N.createFile(w,"unique()",l.video);Y=r.$id,S=r.$id}catch(r){console.warn("Failed to upload stop video:",(r==null?void 0:r.message)||r)}if(l.id){const r={name:l.name,description:l.description,images:f,videoId:Y};typeof l.extraDetails=="string"&&(r.extraDetails=l.extraDetails);try{await p.updateDocument(u,k,l.id,r)}catch(g){const K=String((g==null?void 0:g.message)||g||"");if(/Unknown attribute|Invalid document structure|unknown attribute/i.test(K)){o=!0;const M={name:l.name,description:l.description,imageId:f[0]||null};if(await p.updateDocument(u,k,l.id,M),S){try{await N.deleteFile(w,S)}catch(b){console.warn("Failed to cleanup uploaded video on fallback:",(b==null?void 0:b.message)||b)}j=!0}}else throw g}}else{const r={tripId:y.$id,name:l.name,description:l.description,images:f,videoId:Y,order:l.order||0};typeof l.extraDetails=="string"&&(r.extraDetails=l.extraDetails);try{await p.createDocument(u,k,"unique()",r)}catch(g){const K=String((g==null?void 0:g.message)||g||"");if(/Unknown attribute|Invalid document structure|unknown attribute/i.test(K)){o=!0;const M={tripId:y.$id,name:l.name,description:l.description,imageId:f[0]||null,order:l.order||0};if(await p.createDocument(u,k,"unique()",M),S){try{await N.deleteFile(w,S)}catch(b){console.warn("Failed to cleanup uploaded video on fallback:",(b==null?void 0:b.message)||b)}j=!0}}else throw g}}}if(o||j){let l="";if(o&&(l+='Note: collection lacks "images" attribute; saved stops using legacy single imageId. Add "images" (array<string>) to Trip Stops in Appwrite. '),j&&(l+='Note: collection lacks "videoId" attribute; the uploaded video could not be saved. Add a "videoId" (string) attribute to Trip Stops in Appwrite.'),m){try{await N.deleteFile(w,m)}catch(f){console.warn("Failed to cleanup uploaded trip video:",(f==null?void 0:f.message)||f)}l+=' Also: trip-level video was uploaded but could not be saved; add "videoId" to the Trips collection.'}d(l.trim())}}d("Saved trip successfully"),v(T),h([]),F([]),B({}),E([]),$()}catch(s){console.error(s),d(s.message||"Failed to save trip")}finally{X(!1)}}async function be(t){v({id:t.$id,title:t.title||"",price:t.price||"",date:t.date||"",imageIds:t.imageIds||[],priority:!!t.priority}),P(t.videoId||null),O(null),B({}),E([]);try{const i=((await p.listDocuments(u,k,[])).documents||[]).filter(a=>a.tripId===t.$id).map(a=>({id:a.$id,name:a.name,description:a.description,imageId:a.imageId,images:Array.isArray(a.images)?a.images:a.imageId?[a.imageId]:[],videoId:a.videoId||null}));h(i)}catch(s){console.warn("Failed to load stops for edit:",(s==null?void 0:s.message)||s),h([])}D("trips")}async function ve(t){if(confirm("Delete trip permanently?"))try{await p.deleteDocument(u,R,t),d("Trip deleted"),$()}catch(s){console.error(s),d(s.message||"Failed to delete trip")}}async function Z(t,s){try{await p.updateDocument(u,H,t,{status:s}),d("Booking updated"),A()}catch(i){console.error(i),d(i.message||"Failed to update booking")}}async function je(t){if(confirm("Delete booking?"))try{await p.deleteDocument(u,H,t),d("Booking deleted"),A()}catch(s){console.error(s),d(s.message||"Failed to delete booking")}}async function Ne(t){if(confirm("Delete payment record?"))try{await p.deleteDocument(u,te,t),d("Payment deleted"),V()}catch(s){console.error(s),d(s.message||"Failed to delete payment")}}async function we(){return d("No deploy hook configured in environment")}return e.jsxs("div",{className:"max-w-6xl mx-auto p-4",children:[e.jsx("h1",{className:"text-2xl font-bold my-4",children:"Admin Panel"}),e.jsxs("div",{className:"flex gap-2 mb-4",children:[e.jsx("button",{onClick:()=>D("trips"),className:`px-3 py-1 rounded ${x==="trips"?"bg-indigo-600 text-white":"bg-gray-100"}`,children:"Trips"}),e.jsx("button",{onClick:()=>D("bookings"),className:`px-3 py-1 rounded ${x==="bookings"?"bg-indigo-600 text-white":"bg-gray-100"}`,children:"Bookings"}),e.jsx("button",{onClick:()=>D("payments"),className:`px-3 py-1 rounded ${x==="payments"?"bg-indigo-600 text-white":"bg-gray-100"}`,children:"Payments"}),e.jsx("button",{onClick:()=>D("deploy"),className:`px-3 py-1 rounded ${x==="deploy"?"bg-indigo-600 text-white":"bg-gray-100"}`,children:"Deploy"}),e.jsx("div",{className:"ml-auto text-sm text-gray-600",children:me})]}),x==="trips"&&e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"col-span-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Trips"}),e.jsxs("div",{children:[e.jsx("button",{onClick:$,className:"mr-2 px-2 py-1 bg-gray-100 rounded",children:"Refresh"}),e.jsx("button",{onClick:()=>{v(T),h([]),F([])},className:"px-2 py-1 bg-gray-100 rounded",children:"New"})]})]}),ie?e.jsx("div",{children:"Loading trips..."}):e.jsx("ul",{className:"space-y-3",children:se.map(t=>e.jsxs("li",{className:"border rounded p-3 flex justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"font-semibold",children:t.title}),t.priority&&e.jsx("div",{className:"text-xs bg-yellow-200 text-yellow-800 px-2 py-0.5 rounded",children:"PRIORITY"})]}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Price: ₹",t.price," · Date: ",t.date]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>be(t),className:"px-2 py-1 bg-yellow-100 rounded",children:"Edit"}),e.jsx("button",{onClick:()=>ve(t.$id),className:"px-2 py-1 bg-red-100 rounded",children:"Delete"})]})]},t.$id))})]}),e.jsxs("div",{className:"col-span-1 bg-white rounded shadow p-4",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Create / Edit Trip"}),e.jsxs("form",{onSubmit:fe,className:"space-y-2",children:[e.jsx("input",{className:"w-full border p-2 rounded",value:n.title,onChange:t=>v({...n,title:t.target.value}),placeholder:"Title",required:!0}),e.jsx("input",{className:"w-full border p-2 rounded",value:n.price,onChange:t=>v({...n,price:t.target.value}),placeholder:"Price",type:"number"}),e.jsx("input",{className:"w-full border p-2 rounded",value:n.date,onChange:t=>v({...n,date:t.target.value}),placeholder:"Date",type:"date"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"priority",type:"checkbox",checked:!!n.priority,onChange:t=>v({...n,priority:t.target.checked})}),e.jsx("label",{htmlFor:"priority",className:"text-sm",children:"Priority (feature on Home page)"})]}),e.jsxs("div",{className:"border p-2 rounded",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("strong",{children:"Stops"}),e.jsx("button",{type:"button",onClick:pe,className:"text-sm text-blue-600",children:"Add Stop"})]}),e.jsx("div",{className:"space-y-2",children:_.map((t,s)=>e.jsxs("div",{className:"border p-2 rounded",children:[e.jsx("input",{placeholder:"Stop name",value:t.name||"",onChange:i=>q(s,{name:i.target.value}),className:"w-full mb-1 p-1 border rounded"}),e.jsx("textarea",{placeholder:"Description",value:t.description||"",onChange:i=>q(s,{description:i.target.value}),className:"w-full mb-1 p-1 border rounded"}),e.jsx("textarea",{placeholder:"Extra details (visible on stop details page)",value:t.extraDetails||"",onChange:i=>q(s,{extraDetails:i.target.value}),className:"w-full mb-1 p-1 border rounded"}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"text-sm",children:"Stop images (you can add multiple):"}),e.jsx("input",{type:"file",accept:"image/*",multiple:!0,onChange:i=>ge(s,i.target.files)})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"text-sm",children:"Stop video (optional):"}),e.jsx("input",{type:"file",accept:"video/*",onChange:i=>{var a;return he(s,((a=i.target.files)==null?void 0:a[0])||null)}}),(t.video||t.videoId)&&e.jsxs("div",{className:"mt-2",children:[e.jsx("video",{src:t.video?URL.createObjectURL(t.video):t.videoId?ee(t.videoId):"",className:"w-full max-h-40",controls:!0}),e.jsx("button",{type:"button",onClick:()=>ye(s),className:"text-xs mt-1 px-2 py-1 bg-red-100 rounded",children:"Remove video"})]})]}),t.images&&t.images.length>0&&e.jsx("div",{className:"grid grid-cols-4 gap-2 mb-2",children:t.images.map((i,a)=>e.jsxs("div",{className:"relative border rounded overflow-hidden",children:[e.jsx("img",{src:typeof i=="string"?Ie(i):URL.createObjectURL(i),className:"w-full h-20 object-cover",alt:`stop-${a}`}),e.jsx("button",{type:"button",onClick:()=>xe(s,a),className:"absolute top-1 right-1 bg-white/80 rounded px-1 text-red-600",children:"x"})]},a))}),e.jsx("div",{className:"mt-1 text-right",children:e.jsx("button",{type:"button",onClick:()=>ue(s),className:"text-red-500 text-sm",children:"Remove"})})]},s))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Trip images (optional)"}),Array.isArray(n.imageIds)&&n.imageIds.length>0&&e.jsx("div",{className:"mb-2 grid grid-cols-3 gap-2",children:n.imageIds.map((t,s)=>e.jsxs("div",{className:"relative border rounded overflow-hidden",children:[e.jsx("img",{src:L[s]?URL.createObjectURL(L[s]):ke(t),alt:`img-${s}`,className:"w-full h-28 object-cover"}),e.jsxs("div",{className:"p-1 flex gap-1",children:[e.jsxs("label",{className:"text-xs px-2 py-1 bg-gray-100 rounded cursor-pointer",children:["Replace",e.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:i=>{var m;const a=(m=i.target.files)==null?void 0:m[0];a&&B(y=>({...y,[s]:a}))}})]}),e.jsx("button",{type:"button",onClick:()=>E(i=>Array.from(new Set([...i,s]))),className:"text-xs px-2 py-1 bg-red-100 rounded",children:"Remove"})]}),Q.includes(s)&&e.jsx("div",{className:"absolute inset-0 bg-white/70 flex items-center justify-center text-red-600 font-semibold",children:"Removed"})]},s))}),e.jsx("input",{type:"file",accept:"image/*",multiple:!0,onChange:t=>F(Array.from(t.target.files||[]))}),e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Trip video (optional)"}),e.jsx("input",{type:"file",accept:"video/*",onChange:t=>{var s;O(((s=t.target.files)==null?void 0:s[0])||null),P(null)}}),(C||I)&&e.jsxs("div",{className:"mt-2",children:[e.jsx("video",{src:C?URL.createObjectURL(C):I?ee(I):"",className:"w-full max-h-40",controls:!0}),e.jsx("div",{className:"flex gap-2 mt-1",children:e.jsx("button",{type:"button",onClick:()=>{O(null),P(null)},className:"text-xs px-2 py-1 bg-red-100 rounded",children:"Remove"})})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"submit",disabled:W,className:"bg-blue-600 text-white px-3 py-1 rounded",children:W?"Saving...":"Save"}),e.jsx("button",{type:"button",onClick:()=>{v(T),h([]),F([])},className:"px-3 py-1 rounded bg-gray-100",children:"Cancel"})]})]})]})]}),x==="bookings"&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Bookings"}),e.jsx("button",{onClick:A,className:"px-2 py-1 bg-gray-100 rounded",children:"Refresh"})]}),ne?e.jsx("div",{children:"Loading bookings..."}):e.jsx("ul",{className:"space-y-2",children:le.map(t=>e.jsxs("li",{className:"border rounded p-3 flex justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:t.tripTitle||t.tripId}),e.jsxs("div",{className:"text-sm text-gray-600",children:["User: ",t.userId," · Date: ",t.date]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-2",children:[e.jsx("div",{className:`px-2 py-1 rounded text-sm ${(t.status||"").toLowerCase()==="paid"?"bg-green-100 text-green-800":(t.status||"").toLowerCase()==="failed"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:t.status||"pending"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>Z(t.$id,"paid"),className:"px-2 py-1 bg-green-100 rounded",children:"Mark Paid"}),e.jsx("button",{onClick:()=>Z(t.$id,"failed"),className:"px-2 py-1 bg-red-100 rounded",children:"Mark Failed"}),e.jsx("button",{onClick:()=>je(t.$id),className:"px-2 py-1 bg-gray-100 rounded",children:"Delete"})]})]})]},t.$id))})]}),x==="payments"&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Payments"}),e.jsx("button",{onClick:V,className:"px-2 py-1 bg-gray-100 rounded",children:"Refresh"})]}),ce?e.jsx("div",{children:"Loading payments..."}):e.jsx("ul",{className:"space-y-2",children:de.map(t=>e.jsxs("li",{className:"border rounded p-3 flex justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"font-semibold",children:["Amount: ₹",t.amount||t.amount_paid||"N/A"]}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Method: ",t.method||t.gateway||"N/A"," · Booking: ",t.bookingId||t.orderId]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-2",children:[e.jsx("div",{className:`px-2 py-1 rounded text-sm ${(t.status||"").toLowerCase()==="paid"?"bg-green-100 text-green-800":(t.status||"").toLowerCase()==="failed"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:t.status||"pending"}),e.jsx("div",{className:"flex gap-2",children:e.jsx("button",{onClick:()=>Ne(t.$id),className:"px-2 py-1 bg-gray-100 rounded",children:"Delete"})})]})]},t.$id))})]}),x==="deploy"&&e.jsxs("div",{className:"bg-white p-4 rounded",children:[e.jsx("h2",{className:"font-semibold mb-2",children:"Deploy / Build"}),e.jsxs("div",{className:"mb-3 text-sm text-gray-600",children:["You can trigger a site deploy/build if you configured a build hook URL in environment variable ",e.jsx("code",{children:"VITE_NETLIFY_BUILD_HOOK"})," or ",e.jsx("code",{children:"VITE_DEPLOY_HOOK"}),"."]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:we,className:"px-3 py-1 bg-indigo-600 text-white rounded",children:"Trigger Deploy"}),e.jsx("a",{className:"px-3 py-1 bg-gray-100 rounded",href:"/admin/export",onClick:t=>t.preventDefault(),children:"Export site (not implemented)"})]}),e.jsxs("div",{className:"mt-3 text-sm text-red-500",children:["No deploy hook configured. Set ",e.jsx("code",{children:"VITE_NETLIFY_BUILD_HOOK"})," in your environment to enable one-click deploys."]})]})]})}export{Se as default};
