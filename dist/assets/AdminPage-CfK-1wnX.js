import{r,d as u,j as e,s as j}from"./index-DEwbglG8.js";import{a as ee,b as Ie,g as ke}from"./trips-D8KeeC-s.js";const p="travel_db",R="68a1ce77001ee1b076d4",N="trip-media",k="68a1d1ee00065f1b5f0d",Y="bookings",te="68a1e4dd000b208d3eea";function De(){const[x,C]=r.useState("trips"),[se,ae]=r.useState([]),[ie,H]=r.useState(!1),[ne,le]=r.useState([]),[oe,G]=r.useState(!1),[de,re]=r.useState([]),[ce,z]=r.useState(!1),T={id:null,title:"",price:"",date:"",imageIds:[]},[c,w]=r.useState(T),[S,O]=r.useState(null),[I,_]=r.useState(null),[P,h]=r.useState([]),[U,F]=r.useState([]),[L,B]=r.useState({}),[J,E]=r.useState([]),[Q,W]=r.useState(!1),[me,o]=r.useState("");r.useEffect(()=>{x==="trips"&&$(),x==="bookings"&&A(),x==="payments"&&V()},[x]);async function $(){H(!0),o("");try{const t=await u.listDocuments(p,R);ae(t.documents||[])}catch(t){console.error(t),o(t.message||"Failed to load trips")}finally{H(!1)}}async function A(){G(!0),o("");try{const t=await u.listDocuments(p,Y);le(t.documents||[])}catch(t){console.error(t),o(t.message||"Failed to load bookings")}finally{G(!1)}}async function V(){z(!0),o("");try{const t=await u.listDocuments(p,te);re(t.documents||[])}catch(t){console.error(t),o(t.message||"Failed to load payments")}finally{z(!1)}}const ue=()=>h(t=>[...t,{name:"",description:"",images:[],video:null,videoId:null}]),X=(t,s)=>h(i=>i.map((a,m)=>m===t?{...a,...s}:a)),pe=t=>h(s=>s.filter((i,a)=>a!==t)),ge=(t,s)=>{if(!s||s.length===0)return;const i=Array.from(s);h(a=>a.map((m,f)=>f===t?{...m,images:[...m.images||[],...i]}:m))},xe=(t,s)=>{h(i=>i.map((a,m)=>{if(m!==t)return a;const f=Array.isArray(a.images)?[...a.images]:[];return f.splice(s,1),{...a,images:f}}))},he=(t,s)=>{h(i=>i.map((a,m)=>m===t?{...a,video:s,videoId:null}:a))},fe=t=>{h(s=>s.map((i,a)=>a===t?{...i,video:null,videoId:null}:i))};async function ye(t){t&&t.preventDefault&&t.preventDefault(),W(!0),o("");try{const s=Array.isArray(c.imageIds)?[...c.imageIds]:[],i=[];for(let l=0;l<s.length;l++)if(!J.includes(l))if(L[l]){const v=await j.createFile(N,"unique()",L[l]);i.push(v.$id)}else i.push(s[l]);if(U&&U.length>0){const l=U.map(n=>j.createFile(N,"unique()",n)),v=await Promise.all(l);i.push(...v.map(n=>n.$id))}const a={title:c.title,price:Number(c.price||0),date:c.date||null,imageIds:i};let m=null;if(S instanceof File)try{const l=await j.createFile(N,"unique()",S);m=l.$id,a.videoId=l.$id}catch(l){console.warn("Failed to upload trip-level video:",(l==null?void 0:l.message)||l)}else typeof I=="string"&&I&&(a.videoId=I);let f;if(c.id?f=await u.updateDocument(p,R,c.id,a):f=await u.createDocument(p,R,"unique()",a),k&&P.length>0){let l=!1,v=!1;for(const n of P){const y=[];if(Array.isArray(n.images))for(const d of n.images)if(d instanceof File){const g=await j.createFile(N,"unique()",d);y.push(g.$id)}else typeof d=="string"&&d&&y.push(d);let q=n.videoId||null,D=null;if(n.video instanceof File)try{const d=await j.createFile(N,"unique()",n.video);q=d.$id,D=d.$id}catch(d){console.warn("Failed to upload stop video:",(d==null?void 0:d.message)||d)}if(n.id){const d={name:n.name,description:n.description,images:y,videoId:q};try{await u.updateDocument(p,k,n.id,d)}catch(g){const K=String((g==null?void 0:g.message)||g||"");if(/Unknown attribute|Invalid document structure|unknown attribute/i.test(K)){l=!0;const M={name:n.name,description:n.description,imageId:y[0]||null};if(await u.updateDocument(p,k,n.id,M),D){try{await j.deleteFile(N,D)}catch(b){console.warn("Failed to cleanup uploaded video on fallback:",(b==null?void 0:b.message)||b)}v=!0}}else throw g}}else{const d={tripId:f.$id,name:n.name,description:n.description,images:y,videoId:q,order:n.order||0};try{await u.createDocument(p,k,"unique()",d)}catch(g){const K=String((g==null?void 0:g.message)||g||"");if(/Unknown attribute|Invalid document structure|unknown attribute/i.test(K)){l=!0;const M={tripId:f.$id,name:n.name,description:n.description,imageId:y[0]||null,order:n.order||0};if(await u.createDocument(p,k,"unique()",M),D){try{await j.deleteFile(N,D)}catch(b){console.warn("Failed to cleanup uploaded video on fallback:",(b==null?void 0:b.message)||b)}v=!0}}else throw g}}}if(l||v){let n="";if(l&&(n+='Note: collection lacks "images" attribute; saved stops using legacy single imageId. Add "images" (array<string>) to Trip Stops in Appwrite. '),v&&(n+='Note: collection lacks "videoId" attribute; the uploaded video could not be saved. Add a "videoId" (string) attribute to Trip Stops in Appwrite.'),m){try{await j.deleteFile(N,m)}catch(y){console.warn("Failed to cleanup uploaded trip video:",(y==null?void 0:y.message)||y)}n+=' Also: trip-level video was uploaded but could not be saved; add "videoId" to the Trips collection.'}o(n.trim())}}o("Saved trip successfully"),w(T),h([]),F([]),B({}),E([]),$()}catch(s){console.error(s),o(s.message||"Failed to save trip")}finally{W(!1)}}async function be(t){w({id:t.$id,title:t.title||"",price:t.price||"",date:t.date||"",imageIds:t.imageIds||[]}),_(t.videoId||null),O(null),B({}),E([]);try{const i=((await u.listDocuments(p,k,[])).documents||[]).filter(a=>a.tripId===t.$id).map(a=>({id:a.$id,name:a.name,description:a.description,imageId:a.imageId,images:Array.isArray(a.images)?a.images:a.imageId?[a.imageId]:[],videoId:a.videoId||null}));h(i)}catch(s){console.warn("Failed to load stops for edit:",(s==null?void 0:s.message)||s),h([])}C("trips")}async function ve(t){if(confirm("Delete trip permanently?"))try{await u.deleteDocument(p,R,t),o("Trip deleted"),$()}catch(s){console.error(s),o(s.message||"Failed to delete trip")}}async function Z(t,s){try{await u.updateDocument(p,Y,t,{status:s}),o("Booking updated"),A()}catch(i){console.error(i),o(i.message||"Failed to update booking")}}async function je(t){if(confirm("Delete booking?"))try{await u.deleteDocument(p,Y,t),o("Booking deleted"),A()}catch(s){console.error(s),o(s.message||"Failed to delete booking")}}async function Ne(t){if(confirm("Delete payment record?"))try{await u.deleteDocument(p,te,t),o("Payment deleted"),V()}catch(s){console.error(s),o(s.message||"Failed to delete payment")}}async function we(){return o("No deploy hook configured in environment")}return e.jsxs("div",{className:"max-w-6xl mx-auto p-4",children:[e.jsx("h1",{className:"text-2xl font-bold my-4",children:"Admin Panel"}),e.jsxs("div",{className:"flex gap-2 mb-4",children:[e.jsx("button",{onClick:()=>C("trips"),className:`px-3 py-1 rounded ${x==="trips"?"bg-indigo-600 text-white":"bg-gray-100"}`,children:"Trips"}),e.jsx("button",{onClick:()=>C("bookings"),className:`px-3 py-1 rounded ${x==="bookings"?"bg-indigo-600 text-white":"bg-gray-100"}`,children:"Bookings"}),e.jsx("button",{onClick:()=>C("payments"),className:`px-3 py-1 rounded ${x==="payments"?"bg-indigo-600 text-white":"bg-gray-100"}`,children:"Payments"}),e.jsx("button",{onClick:()=>C("deploy"),className:`px-3 py-1 rounded ${x==="deploy"?"bg-indigo-600 text-white":"bg-gray-100"}`,children:"Deploy"}),e.jsx("div",{className:"ml-auto text-sm text-gray-600",children:me})]}),x==="trips"&&e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"col-span-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Trips"}),e.jsxs("div",{children:[e.jsx("button",{onClick:$,className:"mr-2 px-2 py-1 bg-gray-100 rounded",children:"Refresh"}),e.jsx("button",{onClick:()=>{w(T),h([]),F([])},className:"px-2 py-1 bg-gray-100 rounded",children:"New"})]})]}),ie?e.jsx("div",{children:"Loading trips..."}):e.jsx("ul",{className:"space-y-3",children:se.map(t=>e.jsxs("li",{className:"border rounded p-3 flex justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:t.title}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Price: ₹",t.price," · Date: ",t.date]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>be(t),className:"px-2 py-1 bg-yellow-100 rounded",children:"Edit"}),e.jsx("button",{onClick:()=>ve(t.$id),className:"px-2 py-1 bg-red-100 rounded",children:"Delete"})]})]},t.$id))})]}),e.jsxs("div",{className:"col-span-1 bg-white rounded shadow p-4",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Create / Edit Trip"}),e.jsxs("form",{onSubmit:ye,className:"space-y-2",children:[e.jsx("input",{className:"w-full border p-2 rounded",value:c.title,onChange:t=>w({...c,title:t.target.value}),placeholder:"Title",required:!0}),e.jsx("input",{className:"w-full border p-2 rounded",value:c.price,onChange:t=>w({...c,price:t.target.value}),placeholder:"Price",type:"number"}),e.jsx("input",{className:"w-full border p-2 rounded",value:c.date,onChange:t=>w({...c,date:t.target.value}),placeholder:"Date",type:"date"}),e.jsxs("div",{className:"border p-2 rounded",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("strong",{children:"Stops"}),e.jsx("button",{type:"button",onClick:ue,className:"text-sm text-blue-600",children:"Add Stop"})]}),e.jsx("div",{className:"space-y-2",children:P.map((t,s)=>e.jsxs("div",{className:"border p-2 rounded",children:[e.jsx("input",{placeholder:"Stop name",value:t.name||"",onChange:i=>X(s,{name:i.target.value}),className:"w-full mb-1 p-1 border rounded"}),e.jsx("textarea",{placeholder:"Description",value:t.description||"",onChange:i=>X(s,{description:i.target.value}),className:"w-full mb-1 p-1 border rounded"}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"text-sm",children:"Stop images (you can add multiple):"}),e.jsx("input",{type:"file",accept:"image/*",multiple:!0,onChange:i=>ge(s,i.target.files)})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"text-sm",children:"Stop video (optional):"}),e.jsx("input",{type:"file",accept:"video/*",onChange:i=>{var a;return he(s,((a=i.target.files)==null?void 0:a[0])||null)}}),(t.video||t.videoId)&&e.jsxs("div",{className:"mt-2",children:[e.jsx("video",{src:t.video?URL.createObjectURL(t.video):t.videoId?ee(t.videoId):"",className:"w-full max-h-40",controls:!0}),e.jsx("button",{type:"button",onClick:()=>fe(s),className:"text-xs mt-1 px-2 py-1 bg-red-100 rounded",children:"Remove video"})]})]}),t.images&&t.images.length>0&&e.jsx("div",{className:"grid grid-cols-4 gap-2 mb-2",children:t.images.map((i,a)=>e.jsxs("div",{className:"relative border rounded overflow-hidden",children:[e.jsx("img",{src:typeof i=="string"?Ie(i):URL.createObjectURL(i),className:"w-full h-20 object-cover",alt:`stop-${a}`}),e.jsx("button",{type:"button",onClick:()=>xe(s,a),className:"absolute top-1 right-1 bg-white/80 rounded px-1 text-red-600",children:"x"})]},a))}),e.jsx("div",{className:"mt-1 text-right",children:e.jsx("button",{type:"button",onClick:()=>pe(s),className:"text-red-500 text-sm",children:"Remove"})})]},s))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Trip images (optional)"}),Array.isArray(c.imageIds)&&c.imageIds.length>0&&e.jsx("div",{className:"mb-2 grid grid-cols-3 gap-2",children:c.imageIds.map((t,s)=>e.jsxs("div",{className:"relative border rounded overflow-hidden",children:[e.jsx("img",{src:L[s]?URL.createObjectURL(L[s]):ke(t),alt:`img-${s}`,className:"w-full h-28 object-cover"}),e.jsxs("div",{className:"p-1 flex gap-1",children:[e.jsxs("label",{className:"text-xs px-2 py-1 bg-gray-100 rounded cursor-pointer",children:["Replace",e.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:i=>{var m;const a=(m=i.target.files)==null?void 0:m[0];a&&B(f=>({...f,[s]:a}))}})]}),e.jsx("button",{type:"button",onClick:()=>E(i=>Array.from(new Set([...i,s]))),className:"text-xs px-2 py-1 bg-red-100 rounded",children:"Remove"})]}),J.includes(s)&&e.jsx("div",{className:"absolute inset-0 bg-white/70 flex items-center justify-center text-red-600 font-semibold",children:"Removed"})]},s))}),e.jsx("input",{type:"file",accept:"image/*",multiple:!0,onChange:t=>F(Array.from(t.target.files||[]))}),e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Trip video (optional)"}),e.jsx("input",{type:"file",accept:"video/*",onChange:t=>{var s;O(((s=t.target.files)==null?void 0:s[0])||null),_(null)}}),(S||I)&&e.jsxs("div",{className:"mt-2",children:[e.jsx("video",{src:S?URL.createObjectURL(S):I?ee(I):"",className:"w-full max-h-40",controls:!0}),e.jsx("div",{className:"flex gap-2 mt-1",children:e.jsx("button",{type:"button",onClick:()=>{O(null),_(null)},className:"text-xs px-2 py-1 bg-red-100 rounded",children:"Remove"})})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"submit",disabled:Q,className:"bg-blue-600 text-white px-3 py-1 rounded",children:Q?"Saving...":"Save"}),e.jsx("button",{type:"button",onClick:()=>{w(T),h([]),F([])},className:"px-3 py-1 rounded bg-gray-100",children:"Cancel"})]})]})]})]}),x==="bookings"&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Bookings"}),e.jsx("button",{onClick:A,className:"px-2 py-1 bg-gray-100 rounded",children:"Refresh"})]}),oe?e.jsx("div",{children:"Loading bookings..."}):e.jsx("ul",{className:"space-y-2",children:ne.map(t=>e.jsxs("li",{className:"border rounded p-3 flex justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:t.tripTitle||t.tripId}),e.jsxs("div",{className:"text-sm text-gray-600",children:["User: ",t.userId," · Date: ",t.date]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-2",children:[e.jsx("div",{className:`px-2 py-1 rounded text-sm ${(t.status||"").toLowerCase()==="paid"?"bg-green-100 text-green-800":(t.status||"").toLowerCase()==="failed"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:t.status||"pending"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>Z(t.$id,"paid"),className:"px-2 py-1 bg-green-100 rounded",children:"Mark Paid"}),e.jsx("button",{onClick:()=>Z(t.$id,"failed"),className:"px-2 py-1 bg-red-100 rounded",children:"Mark Failed"}),e.jsx("button",{onClick:()=>je(t.$id),className:"px-2 py-1 bg-gray-100 rounded",children:"Delete"})]})]})]},t.$id))})]}),x==="payments"&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Payments"}),e.jsx("button",{onClick:V,className:"px-2 py-1 bg-gray-100 rounded",children:"Refresh"})]}),ce?e.jsx("div",{children:"Loading payments..."}):e.jsx("ul",{className:"space-y-2",children:de.map(t=>e.jsxs("li",{className:"border rounded p-3 flex justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"font-semibold",children:["Amount: ₹",t.amount||t.amount_paid||"N/A"]}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Method: ",t.method||t.gateway||"N/A"," · Booking: ",t.bookingId||t.orderId]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-2",children:[e.jsx("div",{className:`px-2 py-1 rounded text-sm ${(t.status||"").toLowerCase()==="paid"?"bg-green-100 text-green-800":(t.status||"").toLowerCase()==="failed"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:t.status||"pending"}),e.jsx("div",{className:"flex gap-2",children:e.jsx("button",{onClick:()=>Ne(t.$id),className:"px-2 py-1 bg-gray-100 rounded",children:"Delete"})})]})]},t.$id))})]}),x==="deploy"&&e.jsxs("div",{className:"bg-white p-4 rounded",children:[e.jsx("h2",{className:"font-semibold mb-2",children:"Deploy / Build"}),e.jsxs("div",{className:"mb-3 text-sm text-gray-600",children:["You can trigger a site deploy/build if you configured a build hook URL in environment variable ",e.jsx("code",{children:"VITE_NETLIFY_BUILD_HOOK"})," or ",e.jsx("code",{children:"VITE_DEPLOY_HOOK"}),"."]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:we,className:"px-3 py-1 bg-indigo-600 text-white rounded",children:"Trigger Deploy"}),e.jsx("a",{className:"px-3 py-1 bg-gray-100 rounded",href:"/admin/export",onClick:t=>t.preventDefault(),children:"Export site (not implemented)"})]}),e.jsxs("div",{className:"mt-3 text-sm text-red-500",children:["No deploy hook configured. Set ",e.jsx("code",{children:"VITE_NETLIFY_BUILD_HOOK"})," in your environment to enable one-click deploys."]})]})]})}export{De as default};
